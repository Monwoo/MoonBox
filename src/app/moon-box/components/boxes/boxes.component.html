<div *ngIf="!this.storage.isLocked">
  <mat-card [ngClass]="{ sticky: isSticky }">
    <form *ngIf="filters" class="condensed" [formGroup]="filters.group" #filtersFormRef #filtersForm="ngForm">
      <dynamic-material-form
        [group]="filters.group"
        [model]="filters.model"
        [layout]="filters.layout"
        (change)="onFiltersChange($event)"
      >
        <!--
          ng-template modelId="_password">
              <show-hide-password size="lg" icon="entypo" btnStyle="primary" [btnOutline]="false">
                <ng-content></ng-content>
                <ng-container *ngTemplateOutlet="_password"></ng-container>

              </show-hide-password>
          </ng-template
        -->
        <ng-template modelId="fetchEnd">
          <!-- <pre>{{  index  | json }}</pre> -->

          <button mat-button color="primary" type="button" (click)="toggleFilters($event)">...</button>
          <button
            mat-button
            color="primary"
            matTooltip="{{'mb.boxes.btn.Login.tooltip'|translate}}"
            (click)="login($event)"
          >
            <i class="fas fa-envelope"></i> {{ 'mb.boxes.btn.Login' | translate }}
          </button>
          <button
            mat-button
            color="primary"
            matTooltip="{{'mb.boxes.btn.LoadMore.tooltip'|translate}}"
            (click)="loadNext($event)"
          >
            <i class="fas fa-download"></i> {{ 'mb.boxes.btn.LoadMore' | translate }}
          </button>
        </ng-template>

        <ng-template modelId="mbegKeyTransformer" let-context="context" let-index="index">
          <!-- <pre>{{  index  | json }}</pre> -->

          <button mat-button color="primary" type="button" (click)="clear($event, context, index)">
            {{ 'Remove' | translate }}
          </button>
        </ng-template>
      </dynamic-material-form>

      <button class="condensable" mat-button color="primary" type="button" (click)="addItem()">
        {{ 'Add item' | translate }}
      </button>
    </form>
  </mat-card>

  <moon-box-reader id="0" [filters]="filters.group.value"></moon-box-reader>

  <div *ngFor="let messages of (msgs.service | async | keyvalue); let index = index" class="container-fluid">
    <mat-card class="row">
      <div class="col-12 text-left" (click)="expandMessages($event, messages.key, index)">
        <strong>{{ messages.key }}</strong> ({{ messages.value.numResults }}/{{ messages.value.totalCount }})
      </div>
      <div class="col-12 text-md-left condensed">
        <ng-container *ngFor="let page of messages.value.pages">
          <mat-card *ngFor="let msg of page.msgsOrderedByDate" class="bs box-reader">
            <mat-card-header>
              <div mat-card-avatar>{{ msg.localTime }}</div>
              <mat-card-title>{{ msg.subject }}</mat-card-title>
              <mat-card-subtitle class="container-fluid d-flex">
                <div class="col-3 text-right">{{ msg.expeditorFullName + '=>' + msg.connectionUser }}</div>
                <div class="col-3 text-right">
                  <button mat-button color="primary" type="button" (click)="expandMessage($event, messages.key, index)">
                    ...
                  </button>
                </div>
              </mat-card-subtitle>
            </mat-card-header>
            <mat-card-content>
              <span> {{ '[' + msg.expeditor + '] => ' + msg.to + ' | ' + msg.cc + ' | ' + msg.bcc }} </span>
              <ng-template #msgBody>
                <div class="condensable" [innerHTML]="msg.iframeBody | safeHtml"></div>
              </ng-template>
              <ng-container *ngTemplateOutlet="msgBody"> </ng-container>
            </mat-card-content>
          </mat-card>
        </ng-container>
      </div>
      <div class="col-12 text-md-right">
        <button
          *ngIf="hasMoreMsgs"
          mat-button
          color="primary"
          matTooltip="{{'mb.box-reader.btn.LoadMore.tooltip'|translate}}"
          (click)="loadNext($event)"
        >
          <i class="fas fa-download"></i> {{ 'mb.box-reader.btn.LoadMore' | translate }}
        </button>
      </div>
    </mat-card>
  </div>
</div>
